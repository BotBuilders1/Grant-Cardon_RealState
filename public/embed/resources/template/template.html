<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#webinarEmbedModal">
  Sign Up
</button>

<div id="justMicroContainer" style="height:1px;width:1px;overflow: hidden;">

  <!-- Modal -->
  <div class="" id="webinarEmbedModal" tabindex="-1" role="dialog" aria-labelledby="webinarEmbedModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <div class="col-sm-12" style="margin:0 !important">
            <div id="modalProgressbarDisplay">50% Complete</div>
            <div class="progress" style="height: 1rem;">
              <div id="modalProgressbar"  role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50" class="progress-bar bg-warning" style="width: 50%;"></div>
            </div>
          </div>
        </div>
          
        <div class="modal-body">

          <form id="webinarEmbedForm">

            <div class="modalStep1 text-center">
              <div class="col-sm-12">
                <strong>Next training in: </strong> <span id="startincountdownnumber"></span>
              </div>
              <div class="col-sm-12" style="text-align: center; font-weight: bold; font-size: 2rem;">
                Choose Best Time Option:
              </div>
              <div class="col-sm-12">
                <div role="group" class="input-group">
                  <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-calendar fa-lg"></i></span></div> 
                  <select name="schedule" class="form-control" id="scheduledropdown">
                  </select>
                </div>
              </div>
              <div class="col-sm-12">
                <span style="font-style: italic;">All time options are in your local time.</span>
              </div>
              <div class="col-sm-12">
                <div class="mcwidget-checkbox" data-widget-id="8468485"></div>
              </div>
            </div>

            <div class="modalStep2">
              <div class="col-sm-12">
                <div role="group" class="input-group">
                  <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-user fa-lg"></i></span></div>
                  <input id="first_name" name="first_name" type="text" placeholder="Enter Your First Name" class="form-control" >
                  <div id="first_nameValidation" class="invalid-feedback" style="text-align: left; padding-left: 40px; display: none;">First Name is required!</div>
                </div>
              </div>
              <div class="col-sm-12" style="">
                <div role="group" class="input-group">
                  <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-envelope fa-lg"></i></span></div>
                  <input id="email_address" name="email_address" type="email" placeholder="Enter Your Email Address" class="form-control">
                  <div id="emailValidation1" class="invalid-feedback" style="text-align: left; padding-left: 40px; display: none;">Email Address is required!</div>
                  <div id="emailValidation2" class="invalid-feedback" style="text-align: left; padding-left: 40px; display: none;">Invalid Email Address!</div>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="custom-control custom-checkbox" style="text-align: center;">
                  <input name="sms" type="checkbox" autocomplete="off" class="custom-control-input" value="1" >
                  <label class="custom-control-label" >
                    Send automated reminders so I don't miss it!
                    <img src="/image/red_circle.png" style="height: 44px; position: absolute; left: -40px; top: -11px;">
                  </label>
                </div>
              </div>
              <div class="col-sm-12" id="modalPhoneContainer" style="display: none;">
                <div role="group" class="input-group">
                  <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-mobile fa-lg"></i></span></div>
                  <div class="input-group-prepend">
                    <select name="phone_country_code" class="form-control" id="phone_country_code">
                    </select>
                  </div> 
                  <input name="phone" type="text" placeholder="Enter Your Mobile Number" class="form-control" >
                </div>
              </div>
            </div>


            <div class="col-sm-12">
              <div style="width:50%; margin:0 auto" >

                <div class="modalStep1">
                  <button type="button" id="nextModalButton" class="btn btn-warning">Next Step »</button>
                </div>
                
                <div class="modalStep2">
                  <button type="button" id="confirModalButton" class="btn btn-warning">✓ Complete Registration</button>
                </div>

              
              </div>
            </div>
          </form>

        </div><!-- modal-body closing -->
      </div>
    </div>
  </div>

</div>

<style>
.btn-warning{
  color: #fff;
  background-color: #ffbf00;
  border-color: #ffc000;
  font-weight:bold;
}

.modal-content .modal-body button.btn {
  width: 100% !important;
}

.modal-content .modal-header div.col-sm-12{
  width:100% !important;
  text-align:center !important;
  font-size:0.8rem !important;
  font-weight: bold;
}
.progress .progress-bar { background-color: rgb(80, 146, 24) !important; } 

.modalStep2{
  display: none;
}
.col-sm-12 {
  margin-top: 10px !important;
  margin-bottom: 30px !important;
}
</style>

<script>
function startInCountDownGen ()
{
  var currentDate = new Date();
  var minutes = currentDate.getMinutes();
  var seconds = currentDate.getSeconds();

  while(minutes > 15) {
    minutes = minutes - 15;
  }

  minutes = 15 - minutes;
  seconds = 60 - seconds;

  seconds = (seconds == 60) ? 0 : seconds;

    // Stop when reach 0
  if (minutes == 0 && seconds == 0) {
    document.getElementById('startincountdownnumber').innerHTML = minutes + seconds;
    return false;
  }

    // set this to the downdown container
    document.getElementById('startincountdownnumber').innerHTML = minutes + ' min ' + seconds + ' sec';

    // migth use in the future (Fri Nov 29 2019 04:14:40 GMT+0800 (China Standard Time) "01" ":19")
  // console.log(currentDate, minutes, seconds);

  setTimeout(() => { startInCountDownGen() }, 1000);

}

function GlobalTimeZoneGMTFuntion ()
{
  String.prototype.splice = function(idx, rem, str) {
      return this.slice(0, idx) + str + this.slice(idx + Math.abs(rem));
  };

  var currentDate = new Date();
  
  var arrayDate = String(currentDate).split(" ");

  return String(arrayDate[5]).splice(6, 0, ':');
}

function isEmail($email){
  var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  return regex.test($email);
}

var GlobalTimeZoneGMT = GlobalTimeZoneGMTFuntion();
var GlobalSchedulesResult = {};
var GlobalPhoneCodeResult = {};


$(document).ready(function () {
  startInCountDownGen();
  

  setTimeout(()=>{
    $("#webinarEmbedModal").addClass('modal fade')
  }, 2000)

  $('#nextModalButton').on('click', function(){
    $('#modalProgressbar').width('75%');
    $('#modalProgressbarDisplay').html('75% Complete');

    $('.modalStep1').hide();
    $('.modalStep2').show();
  })

  $('.custom-checkbox').on('click', function(){
    var checkBoxes = $("input.custom-control-input");
    checkBoxes.prop("checked", !checkBoxes.prop("checked"));

    if(checkBoxes.prop("checked")){
      $('#modalPhoneContainer').show();
    }else{
      $('#modalPhoneContainer').hide();
    }
  })

  $.ajax({
    url: $baseUrl + "api/v1/embed/get-schedule/" + GlobalTimeZoneGMT,
    type: "GET",
    success: function(res) {
      GlobalSchedulesResult = res;

      for(var x=0; x < res.schedules.length; x++){
        $('#scheduledropdown').append(new Option(res.schedules[x].date, res.schedules[x].schedule));
      } 

          // $('#phone_country_code').val(res.country_code);
    }
  });

  $.ajax({
    url: $baseUrl + "api/v1/embed/get-phone-code",
    type: "GET",
    success: function(res) {
      GlobalPhoneCodeResult = res
      $.each(res, function(k,v){
          $('#phone_country_code').append(new Option( k + ' +' + v.code, k));
      })

    }
  });

  $('#first_name').on('input propertychange paste',function () {
    if($('#first_name').val().length > 0) {
      $('#first_nameValidation').hide();
      $('#first_name').removeClass('is-invalid');

    }
  })

  $('#email_address').on('input propertychange paste',function () {
    var emailValid = isEmail($('#email_address').val());

    if($('#email_address').val().length > 0) {
      $('#emailValidation1').hide();
      $('#email_address').removeClass('is-invalid');

    }

    if(emailValid){
      $('#emailValidation2').hide();
      $('#email_address').removeClass('is-invalid');
    }

  })

  $('#confirModalButton').on('click', function(e){

    var formError = false;
    if($('#first_name').val().length <= 0) {
      formError = true;
      $('#first_nameValidation').show();
      $('#first_name').addClass('is-invalid');

    }

    var emailValid = isEmail($('#email_address').val());
    
    if($('#email_address').val().length <= 0) {
      formError = true;
      $('#emailValidation1').show();
      $('#email_address').addClass('is-invalid');

    } else if(!emailValid){
      formError = true;
      $('#emailValidation2').show();
      $('#email_address').addClass('is-invalid');
    }

    if(formError) {
      e.preventDefault()
      return
    }

    var formSerialized = $('#webinarEmbedForm').serializeArray();
    formValues = {
      'first_name': '',
      'last_name': '',
      'email': '',
      'schedule': '',
      'ip_address': '',
      'phone_country_code': '',
      'phone': '',
      'timezone': '',
      'real_dates': 1,
      'sms': '',
      'schedule_code': '',
      'hidden_schedule': '',
      'php_timezone': '',
      'list_data': '',
    };

    $.each(formSerialized, function(k, v){
      formValues[v.name] = v.value
    })

    formValues['phone_country_code'] = GlobalPhoneCodeResult[formValues['phone_country_code']].code;

    var list_data = {
        'description': GlobalSchedulesResult.description,
        'name': GlobalSchedulesResult.name,
        'presenters': GlobalSchedulesResult.presenters
    }

    formValues['last_name'] = '';
    formValues['ip_address'] = '';
    formValues['real_dates'] = 1;
    formValues['list_data'] = list_data;
    formValues['php_timezone'] = GlobalSchedulesResult.timezone;
    formValues['hidden_schedule'] = GlobalSchedulesResult.internal_status[formValues['schedule']];
    formValues['schedule_code'] = formValues['schedule'];
    formValues['timezone'] = GlobalTimeZoneGMT;
    formValues['email'] = formValues['email_address'];
    formValues['embed'] = true;


    $.ajax({
      url: $baseUrl + "api/v1/embed/set-schedule?",
      type: "POST",
      data: formValues,
      dataType: "JSON",
      success: function(res) {
        window.location.href = $baseUrl + 'thankyouraw/' + res
      }
    });

  })


})
</script>

<script src="//widget.manychat.com/105391664256044.js" async="async"></script>